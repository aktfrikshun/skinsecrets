#!/bin/bash -e

# Exit immediately if a command exits with a non-zero status
set -o errexit

# Exit immediately if a pipeline returns a non-zero status
set -o pipefail

# Exit immediately if an unset variable is referenced
set -o nounset

# Ensure production environment is set
export RAILS_ENV=production

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# Function to log messages
log() {
    echo "[$(date +'%Y-%m-%d %H:%M:%S')] $1"
}

# Function to check if database is ready
wait_for_db() {
    log "Waiting for database to be ready..."
    
    # For SQLite, we need to create the database first
    log "Creating SQLite database if it doesn't exist..."
    bundle exec rails db:create 2>/dev/null || true
    
    # Check if database file exists
    if [ -f "/data/ss_production.sqlite3" ]; then
        log "Database file exists at /data/ss_production.sqlite3"
    else
        log "Database file not found at /data/ss_production.sqlite3"
    fi
    
    # Try to run migrations to ensure database is properly set up
    log "Running initial database setup..."
    bundle exec rails db:migrate 2>/dev/null || true
    
    log "Database is ready!"
}

# Function to run database migrations
run_migrations() {
    log "Running database migrations..."
    bundle exec rails db:migrate
    log "Database migrations completed"
}

# Function to check if we need to seed the database
seed_database() {
    if [ -f "db/seeds.rb" ]; then
        log "Checking if database needs seeding..."
        if bundle exec rails runner "exit User.count == 0" 2>/dev/null; then
            log "Database is empty, running seeds..."
            bundle exec rails db:seed
            log "Database seeding completed"
        else
            log "Database already has data, skipping seeds"
        fi
    fi
}

# Function to precompile assets if needed
precompile_assets() {
    if [ ! -d "public/assets" ] || [ -z "$(ls -A public/assets 2>/dev/null)" ]; then
        log "Precompiling assets..."
        bundle exec rails assets:precompile
        log "Asset precompilation completed"
    else
        log "Assets already precompiled, skipping"
    fi
}

# Function to clean up old server.pid files
cleanup_pid() {
    log "Cleaning up old server.pid files..."
    rm -f tmp/pids/server.pid
}

# Function to set up storage directory
setup_storage() {
    log "Setting up storage directory..."
    mkdir -p storage tmp/cache tmp/pids tmp/sockets
    chmod -R 755 storage tmp
}

# Main execution
main() {
    log "Starting Rails application in production mode..."
    
    # Clean up any existing server.pid
    cleanup_pid
    
    # Set up storage directories
    setup_storage
    
    # Wait for database to be ready
    wait_for_db
    
    # Run migrations
    run_migrations
    
    # Seed database if needed
    seed_database
    
    # Precompile assets if needed
    precompile_assets
    
    log "Rails application is ready to start"
    
    # Execute the main command
    exec "$@"
}

# Run main function with all arguments
main "$@"
