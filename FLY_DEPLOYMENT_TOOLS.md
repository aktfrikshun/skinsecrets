# Fly.io Deployment Tools for Skin Secrets

This document describes the automated tools created for deploying your Skin Secrets app to Fly.io.

## üõ†Ô∏è **Available Tools**

### 1. **Dynamic Secrets Generator** (`scripts/generate_fly_secrets.rb`)

Automatically reads your Rails credentials and generates Fly.io secrets commands.

```bash
# Generate secrets commands for default app name (skin-secrets)
rbenv exec bundle exec ruby scripts/generate_fly_secrets.rb

# Generate secrets commands for custom app name
rbenv exec bundle exec ruby scripts/generate_fly_secrets.rb my-app-name
```

**Output includes:**
- Individual `fly secrets set` commands for each credential
- Single command with all secrets
- Additional required secrets (RAILS_MASTER_KEY)
- Quick deployment commands

### 2. **Shell Wrapper** (`scripts/generate_fly_secrets.sh`)

User-friendly wrapper for the secrets generator.

```bash
# Generate secrets commands
./scripts/generate_fly_secrets.sh

# Generate for custom app name
./scripts/generate_fly_secrets.sh my-app-name
```

### 3. **Complete Setup Script** (`scripts/setup_fly_deployment.sh`)

Generates a complete deployment script with all secrets and commands.

```bash
# Generate deployment script for default app name
./scripts/setup_fly_deployment.sh

# Generate for custom app name
./scripts/setup_fly_deployment.sh my-app-name
```

**Creates:** `deploy_[app-name].sh` - Complete deployment script

### 4. **Auto-Generated Deployment Script** (`deploy_[app-name].sh`)

Complete deployment script generated by the setup tool.

```bash
# Deploy your app
./deploy_skin-secrets.sh
```

## üîê **Secrets Management**

### **Automatically Detected Secrets**

The tools automatically detect and generate commands for:

- `SECRET_KEY_BASE` - Rails secret key base
- `OPENAI_API_KEY` - OpenAI API key for AI features
- `FACEBOOK_PAGE_ACCESS_TOKEN` - Facebook page access token
- `FACEBOOK_PAGE_ID` - Facebook page ID
- `RAILS_MASTER_KEY` - Rails master key (from config/master.key)

### **Example Generated Commands**

```bash
# Individual commands
fly secrets set SECRET_KEY_BASE="your_secret_key" --app skin-secrets
fly secrets set OPENAI_API_KEY="your_openai_key" --app skin-secrets
fly secrets set FACEBOOK_PAGE_ACCESS_TOKEN="your_facebook_token" --app skin-secrets
fly secrets set FACEBOOK_PAGE_ID="your_page_id" --app skin-secrets
fly secrets set RAILS_MASTER_KEY="$(cat config/master.key)" --app skin-secrets

# All secrets in one command
fly secrets set SECRET_KEY_BASE="..." OPENAI_API_KEY="..." FACEBOOK_PAGE_ACCESS_TOKEN="..." FACEBOOK_PAGE_ID="..." --app skin-secrets
```

## üöÄ **Quick Deployment**

### **Option 1: One-Command Deployment**

```bash
# Generate and run deployment script
./scripts/setup_fly_deployment.sh && ./deploy_skin-secrets.sh
```

### **Option 2: Manual Deployment**

```bash
# 1. Generate secrets commands
./scripts/generate_fly_secrets.sh

# 2. Copy and run the generated commands
# 3. Create app and volume
fly apps create skin-secrets
fly volumes create skin_secrets_data --size 10 --region iad --app skin-secrets

# 4. Deploy
fly deploy --app skin-secrets
```

## üìã **Configuration Files**

### **fly.toml**
- App configuration for Fly.io
- Environment variables
- Health checks
- Resource allocation
- Auto-scaling settings

### **Dockerfile**
- Production-ready Docker configuration
- Multi-stage build for optimization
- Security best practices
- Asset precompilation

## üîç **Monitoring & Management**

### **Generated Commands**

The deployment script includes these useful commands:

```bash
# View logs
fly logs --app skin-secrets

# Open in browser
fly open --app skin-secrets

# SSH into app
fly ssh console --app skin-secrets

# Check status
fly status --app skin-secrets
```

### **Health Checks**

- **Endpoint**: `/up`
- **Interval**: 30 seconds
- **Timeout**: 5 seconds
- **Grace Period**: 10 seconds

## üí∞ **Cost Optimization**

- **Auto-stop**: Machines stop when not in use
- **Min machines**: 1 machine always running
- **Shared CPU**: Most cost-effective option
- **SQLite**: No additional database costs

## üîß **Customization**

### **Change App Name**

```bash
# Generate for different app name
./scripts/setup_fly_deployment.sh my-custom-app-name
```

### **Modify Configuration**

Edit `fly.toml` to change:
- Memory allocation
- CPU allocation
- Region
- Environment variables
- Health check settings

### **Add Custom Secrets**

1. Add to Rails credentials:
   ```bash
   rbenv exec bundle exec rails credentials:edit
   ```

2. Regenerate deployment script:
   ```bash
   ./scripts/setup_fly_deployment.sh
   ```

## üõ°Ô∏è **Security**

- **Secrets**: Stored as Fly.io secrets (encrypted)
- **HTTPS**: Forced for all connections
- **Non-root user**: App runs as user 1000
- **Health checks**: Regular monitoring
- **Auto-scaling**: Stops when not in use

## üìö **Troubleshooting**

### **Common Issues**

1. **Fly CLI not installed**
   ```bash
   # Install Fly CLI
   curl -L https://fly.io/install.sh | sh
   ```

2. **Not logged in**
   ```bash
   # Login to Fly.io
   fly auth login
   ```

3. **App name already exists**
   - Use a different app name
   - Or delete existing app: `fly apps destroy existing-app-name`

4. **Secrets not set**
   - Run the secrets generator again
   - Check that credentials are properly configured

### **Debug Commands**

```bash
# Check app status
fly status --app skin-secrets

# View recent deployments
fly releases --app skin-secrets

# SSH into app for debugging
fly ssh console --app skin-secrets

# View logs
fly logs --app skin-secrets
```

## üìû **Support**

- [Fly.io Documentation](https://fly.io/docs/)
- [Rails on Fly.io](https://fly.io/docs/rails/)
- [Fly.io Community](https://community.fly.io/)

## üéØ **Next Steps**

1. **Install Fly CLI**: https://fly.io/docs/hands-on/install-flyctl/
2. **Sign up for Fly.io**: https://fly.io/docs/hands-on/sign-up/
3. **Login**: `fly auth login`
4. **Deploy**: `./scripts/setup_fly_deployment.sh && ./deploy_skin-secrets.sh`
5. **Monitor**: Use the generated monitoring commands 